import streamlit as st
from datetime import datetime

st.set_page_config(
    page_title="MBTI 학습 코치",
    page_icon="📚",
    layout="wide",
)

# -------------------------------
# Helper data & functions
# -------------------------------
MBTI_TYPES = [
    "ISTJ", "ISFJ", "INFJ", "INTJ",
    "ISTP", "ISFP", "INFP", "INTP",
    "ESTP", "ESFP", "ENFP", "ENTP",
    "ESTJ", "ESFJ", "ENFJ", "ENTJ",
]

DICHOTOMY_TIPS = {
    "E": {
        "요약": "사람들과 상호작용하며 에너지를 얻어요.",
        "전략": [
            "스터디 그룹/페어 스터디로 동기 유지",
            "소리 내어 설명하기(teach-back)로 이해 점검",
            "집중 구간 30분 후 5분 대화/걷기 리프레시"
        ],
    },
    "I": {
        "요약": "혼자 있는 시간에서 에너지를 얻어요.",
        "전략": [
            "조용한 공간에서 딥워크(50–90분) 블록 설정",
            "비동기 스터디(공유 노트/질문 게시판) 활용",
            "발표/스피치 대비는 독백→녹음→요약 순서로"
        ],
    },
    "S": {
        "요약": "구체적 사실과 절차에 강해요.",
        "전략": [
            "예제→유형화→변형 문제 순서로 연습",
            "체크리스트/매뉴얼 정리 후 반복",
            "실습·모의고사로 피드백 루프 가속"
        ],
    },
    "N": {
        "요약": "패턴·아이디어를 통해 이해해요.",
        "전략": [
            "마인드맵/개념도 먼저 구성 후 세부 암기",
            "비유·스토리로 개념 연결",
            "주차별 ‘큰 질문(Why/So what?)’ 설정"
        ],
    },
    "T": {
        "요약": "논리와 객관 기준을 중시해요.",
        "전략": [
            "채점 기준표(루브릭)로 자기 채점",
            "오답은 원인-가설-개선 실험노트로 기록",
            "데이터 기반 진도·정확도 트래킹"
        ],
    },
    "F": {
        "요약": "가치·관계 맥락에서 동기부여가 커요.",
        "전략": [
            "의미·목적 문장(Why 문장) 작성 후 시작",
            "동료와 상호격려 캘린더 운영",
            "감정 과부하 시 5분 감정 쓰기→재집중"
        ],
    },
    "J": {
        "요약": "계획과 마감이 동기부여예요.",
        "전략": [
            "주간 로드맵(목표→과업→마감) 고정",
            "완료 체크박스/버전 관리로 가시화",
            "마감 하루 전 ‘리허설 데이’ 운영"
        ],
    },
    "P": {
        "요약": "유연성과 탐색에서 성과가 나와요.",
        "전략": [
            "타임박싱: 25–40분 스프린트 + 10분 정리",
            "선실행(빠른 초안)→반복 개선",
            "선택지 3개 중 하나 즉시 시작(과도한 계획 방지)"
        ],
    },
}

TYPE_EXTRAS = {
    "ISTJ": ["표준서·기출 우선, 주간 점검 루틴 고정", "오답은 근거 규정과 연결"],
    "ISFJ": ["작은 성공경험 누적(미니퀘스트)", "동료 도움 일정화로 정서 안정"],
    "INFJ": ["목표 의미를 서사로 정리", "심층 논술·에세이는 구조 틀 먼저"],
    "INTJ": ["백캐스팅(최종 목표→역산 계획)", "시스템·자동화로 반복 제거"],
    "ISTP": ["핵심만 빠르게 파악 후 실습", "요약은 도식·흐름도로"],
    "ISFP": ["미적·감각 요소(색/폰트)로 노트 동기화", "마감은 동료와 약속으로 고정"],
    "INFP": ["가치-학습 연결문장 작성", "완벽주의 방지: 초안→수정 2회 제한"],
    "INTP": ["가설-검증 사이클로 탐구", "정리 미루지 말고 ‘끝맺기 타임’ 별도 확보"],
    "ESTP": ["실전형 모의·프로젝트 선호", "짧은 스프린트 반복으로 지루함 방지"],
    "ESFP": ["학습을 이벤트화(타이머·도전 과제)", "페어 스터디로 즐거움+책임"],
    "ENFP": ["아이디어 수렴 후 3가지로 축소", "할 일은 45분 미션 단위로"],
    "ENTP": ["토론·디베이트로 개념 정교화", "아이디어 과잉 방지 위해 결론 타임"],
    "ESTJ": ["성과지표(KPI)로 진도 통제", "팀 스터디 리드하며 리허설 주도"],
    "ESFJ": ["상호의존 계획표(누가-언제-무엇)", "피드백 라운드 정례화"],
    "ENFJ": ["멘토링/튜터링이 최고의 학습", "발표 리허설→카드뉴스 요약"],
    "ENTJ": ["OKR식 목표관리", "위임·자동화로 고난도 과제에 집중"],
}

TOOLS = [
    "타이머: Pomofocus, Toggl Track",
    "노트: Obsidian, Notion, Google Docs",
    "마인드맵: XMind, Miro",
    "플래시카드: Anki, Quizlet",
    "집중: Forest, Focus To-Do",
]

def make_plan(mbti: str, minutes_per_day: int = 90):
    letters = list(mbti)
    blocks = []
    insights = []

    for L in letters:
        t = DICHOTOMY_TIPS[L]
        insights.append(f"**{L}** · {t['요약']}")
        blocks.extend(t["전략"]) 

    extras = TYPE_EXTRAS.get(mbti, [])

    # 간단한 데일리 타임블록 설계
    # 최소 50분 블록을 기준으로 구성 (잔여는 복습/정리)
    focus = max(50, int(minutes_per_day * 0.6))
    review = max(20, int(minutes_per_day * 0.25))
    admin = max(10, minutes_per_day - focus - review)

    schedule = [
        ("딥포커스", focus, "핵심 개념/문제풀이/프로
